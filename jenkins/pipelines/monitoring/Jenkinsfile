pipeline {
    agent any

    environment {
        DOCKER_USER = 'madalinatoader'
    }

    stages {
        stage('Declarative: Checkout SCM') {
            steps {
                checkout([$class: 'GitSCM',
                    branches: [[name: 'main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/ToaderMadalina/platforma-monitorizare.git',
                        credentialsId: 'dockerhub-creds'
                    ]]
                ])
            }
        }

        stage('Checkout SCM') {
            steps {
                echo 'Clonam repository-ul...'
                git branch: 'main',
                    url: 'https://github.com/ToaderMadalina/platforma-monitorizare.git'
            }
        }

        stage('Lint Bash Script') {
            steps {
                echo 'Verificam scriptul de monitorizare...'
                script {
                    if (sh(script: "command -v shellcheck || true", returnStatus: true) == 0) {
                        sh 'shellcheck scripts/monitoring.sh'
                    } else {
                        echo 'ShellCheck nu este instalat, se omite verificarea.'
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'Construim imaginea Docker...'
                sh '''
                    docker build -t madalinatoader/monitorizare-image \
                    -f jenkins/pipelines/monitoring/Dockerfile .
                '''
            }
        }

        stage('Docker Login & Push') {
            steps {
                echo 'Autentificare in Docker Hub si push...'
                withCredentials([string(credentialsId: 'dockerhub-creds', variable: 'DOCKER_PASS')]) {
                    sh '''
                        echo $DOCKER_PASS | docker login -u madalinatoader --password-stdin
                        docker push madalinatoader/monitorizare-image
                    '''
                }
            }
        }

        stage('Deploy') {
            steps {
                echo 'Deploy local (sau pe server remote)...'
                sh '''
                    docker run --rm \
                    -v /docker/monitoring/data:/data \
                    madalinatoader/monitorizare-image \
                    /bin/sh /app/monitoring.sh
                '''
            }
        }
    }

    post {
        success {
            echo 'Pipeline finalizat cu succes!'
        }
        failure {
            echo 'Pipeline esuat!'
        }
    }
}

